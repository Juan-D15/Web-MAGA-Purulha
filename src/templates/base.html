{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'img/logos/maga_logo.png' %}?v=2">
  <link rel="icon" type="image/png" sizes="16x16" href="{% static 'img/logos/maga_logo.png' %}?v=2">
  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/logos/maga_logo.png' %}?v=2">
  <link rel="shortcut icon" type="image/png" href="{% static 'img/logos/maga_logo.png' %}?v=2">
  <title>{% block title %}Gesti√≥n de Eventos ‚Äî Purulh√°{% endblock %}</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}?v=3">
  <link rel="stylesheet" href="{% static 'css/login-modal.css' %}">
  
  {% block extra_css %}{% endblock %}
</head>
<body>

  <div id="offlineBanner" class="offline-banner" role="status" aria-live="assertive" aria-hidden="true">
    <span class="offline-indicator"></span>
    <span class="offline-text">Sin conexi√≥n a Internet</span>
    <span class="offline-subtext">Tus cambios se guardar√°n y se enviar√°n autom√°ticamente cuando vuelva la conexi√≥n.</span>
  </div>

  <!-- Indicador de estado de sincronizaci√≥n (clickeable para forzar sincronizaci√≥n) -->
  <div id="syncStatus" class="sync-status" style="display: none;" role="button" tabindex="0" aria-label="Forzar sincronizaci√≥n" title="Haz clic para forzar la sincronizaci√≥n">
    <div class="sync-status-content">
      <span class="sync-icon">üîÑ</span>
      <span class="sync-text">Sincronizando...</span>
      <span class="sync-count">0 pendientes</span>
    </div>
  </div>

  <!-- ======= TOP / ENCABEZADO ======= -->
  <header class="topbar" role="banner">
    <div class="topbar__inner">
      <!-- Logos para escritorio (MAGA a la izquierda) + un logo m√≥vil adicional -->
        <div class="brand" aria-label="Logotipos">
          <img src="{% static 'img/logos/logo_maga.png' %}" alt="Logo MAGA" loading="eager" class="brand__maga">
          <!-- Este segundo logo solo se muestra en m√≥vil para "juntar los dos logos" -->
          <img src="{% static 'img/logos/maga_logo.png' %}" alt="Logo Purulh√° (m√≥vil)" class="brand__purulha-mobile" loading="eager">
        </div>

      <!-- T√≠tulos (se ocultan en m√≥vil) -->
      <div class="headline">
        <h1>MAGA ‚Äî PURULH√Å</h1>
        <p>{% block header_subtitle %}Gesti√≥n de Eventos{% endblock %}</p>
      </div>

      <div class="right-actions">
        <!-- Logo de MAGA (solo escritorio/tablet) -->
        <div class="right-logo" aria-label="Logo MAGA">
          <img src="{% static 'img/logos/maga_logo.png' %}" alt="Logo MAGA" loading="eager">
        </div>
        <!-- Bot√≥n hamburguesa (m√≥vil) -->
        <button class="hamburger" id="btnHamburger" aria-label="Abrir men√∫" aria-controls="drawer" aria-expanded="false">
          <span></span><span></span><span></span>
        </button>
      </div>
    </div>

    <!-- ======= NAV ======= -->
    <nav class="nav" role="navigation" aria-label="Men√∫ principal">
      <div class="nav__inner">
        <!-- √çtems de la cinta (ocultos en m√≥vil) -->
        <div class="nav__group">
          <a class="nav__link {% block nav_inicio %}{% endblock %}" href="{% url 'webmaga:index' %}">Inicio</a>
          <a class="nav__link {% block nav_mapa %}{% endblock %}" href="{% url 'webmaga:mapa-completo' %}">Mapa</a>

          <!-- Proyectos Activos -->
          <div class="dd">
            <button class="dd__btn nav__link" aria-haspopup="true" aria-expanded="false">
              Proyectos Activos <span class="chev" aria-hidden="true"></span>
            </button>
            <div class="dd__panel" role="menu" aria-label="Proyectos Activos">
              <div class="dd__section">
                <div class="dd__grid">
                  <a class="dd__item" href="{% url 'webmaga:proyectos' %}" role="menuitem" tabindex="0">Ver Todos</a>
                  <a class="dd__item" href="{% url 'webmaga:proyectos' %}#capacitaciones" role="menuitem" tabindex="0">Capacitaciones</a>
                  <a class="dd__item" href="{% url 'webmaga:proyectos' %}#entregas" role="menuitem" tabindex="0">Entregas</a>
                  <a class="dd__item" href="{% url 'webmaga:proyectos' %}#proyectos-ayuda" role="menuitem" tabindex="0">Proyectos de Ayuda</a>
                </div>
              </div>
            </div>
          </div>

          <!-- Gestiones (Solo para Admin) -->
          {% if es_admin %}
          <div class="dd">
            <button class="dd__btn nav__link" aria-haspopup="true" aria-expanded="false">
              Gestiones <span class="chev" aria-hidden="true"></span>
            </button>
            <div class="dd__panel" role="menu" aria-label="Gestiones">
              <div class="dd__section">
                <div class="dd__grid">
                  <a class="dd__item" href="#" onclick="handleGestionesAction('createEventView'); return false;" role="menuitem" tabindex="0">Agregar Evento</a>
                  <a class="dd__item" href="#" onclick="handleGestionesAction('manageEventView'); return false;" role="menuitem" tabindex="0">Editar Evento</a>
                  <a class="dd__item" href="{% url 'webmaga:gestionusuarios' %}" role="menuitem" tabindex="0">Gesti√≥n Usuarios</a>
                  <a class="dd__item" href="{% url 'webmaga:reportes-index' %}" role="menuitem" tabindex="0">Crear Reporte</a>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Comunidades -->
          <div class="dd">
            <button class="dd__btn nav__link" aria-haspopup="true" aria-expanded="false">
              Comunidades <span class="chev" aria-hidden="true"></span>
            </button>
            <div class="dd__panel" role="menu" aria-label="Comunidades">
              <div class="dd__search" role="search">
                <button type="button" class="dd__search-btn" id="search-comunidades-btn" aria-label="Buscar comunidades" title="Buscar comunidades">
                  <svg class="icon icon--white" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                  </svg>
                </button>
                <input type="search" placeholder="Buscar comunidades‚Ä¶" aria-label="Buscar comunidades" id="search-comunidades">
              </div>
              <div class="dd__section">
                <div class="dd__grid" id="comunidades-list">
                  <a class="dd__item" href="{% url 'webmaga:comunidades' %}" role="menuitem" tabindex="0" data-name="Ver Comunidades">Ver Comunidades</a>
                  <a class="dd__item" href="{% url 'webmaga:regiones' %}" role="menuitem" tabindex="0" data-name="Ver Regiones">Ver Regiones</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Buscador principal (permanece en m√≥vil) - Busca PROYECTOS -->
        <div class="search" role="search">
          <div class="search__wrap">
            <input id="{% block search_input_id %}buscar-proyecto{% endblock %}" type="search" placeholder="{% block search_placeholder %}Buscar proyecto‚Ä¶{% endblock %}" aria-label="{% block search_label %}Buscar proyecto{% endblock %}">
            <button class="mini mini--ghost" aria-label="Buscar">
              <span class="icon icon--white" aria-hidden="true"></span>
            </button>
          </div>
        </div>

        <!-- Icono de usuario en desktop (junto al buscador) -->
        <div class="nav-user-icon" id="navUserIcon" aria-label="Informaci√≥n de usuario">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>

      </div>
    </nav>
  </header>

  <!-- Dropdown flotante del usuario (fuera de la cinta) -->
  <div class="nav-user-dropdown" id="navUserDropdown" style="display: none;">
    <!-- Contenido cuando hay sesi√≥n activa -->
    <div class="nav-user-dropdown-content" id="navUserLoggedIn" style="display: {% if user.is_authenticated %}block{% else %}none{% endif %};">
      <div class="nav-user-dropdown-header">
      <div class="nav-user-dropdown-avatar" id="navUserAvatar">
        <span class="avatar-initial-text" id="navUserAvatarInitial">{% if usuario_maga %}{{ usuario_maga.username|first|upper }}{% else %}U{% endif %}</span>
        <img id="navUserAvatarImage" src="" alt="Foto de perfil" style="display: none;">
      </div>
      <div>
        <h4 class="nav-user-dropdown-name" id="navUserName">
          {% if usuario_maga %}{{ usuario_maga.username }}{% else %}Usuario{% endif %}
        </h4>
        <p class="nav-user-dropdown-email" id="navUserEmail">
          {% if usuario_maga %}{{ usuario_maga.email }}{% else %}usuario@maga.gt{% endif %}
        </p>
      </div>
    </div>
    <div class="nav-user-dropdown-menu">
      <a href="{% url 'webmaga:perfilusuario' %}" class="nav-user-dropdown-item" id="navProfileBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        Mi Perfil
      </a>
      <a href="{% url 'webmaga:configgeneral' %}" class="nav-user-dropdown-item" id="navSettingsBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        Configuraci√≥n
      </a>
      <div class="nav-user-dropdown-divider"></div>
      <button class="nav-user-dropdown-item" id="navLogoutBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Cerrar Sesi√≥n
      </button>
    </div>
    </div>

    <!-- Contenido cuando NO hay sesi√≥n activa -->
    <div class="nav-user-dropdown-content" id="navUserLoggedOut" style="display: {% if user.is_authenticated %}none{% else %}block{% endif %};">
      <div class="nav-user-dropdown-header">
        <div class="nav-user-dropdown-avatar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div>
          <h4 class="nav-user-dropdown-name">Iniciar Sesi√≥n</h4>
          <p class="nav-user-dropdown-email">Accede al sistema</p>
        </div>
      </div>
      <div class="nav-user-dropdown-menu">
        <a href="{% url 'webmaga:configgeneral' %}" class="nav-user-dropdown-item" id="navConfigBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
          Configuraci√≥n
        </a>
        <div class="nav-user-dropdown-divider"></div>
        <button class="nav-user-dropdown-item nav-user-dropdown-primary" id="navLoginBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <polyline points="10 17 15 12 10 7"></polyline>
            <line x1="15" y1="12" x2="3" y2="12"></line>
          </svg>
          Acceder al Sistema
        </button>
        <div class="nav-user-dropdown-divider"></div>
        <button class="nav-user-dropdown-item" id="navCloseBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- ======= DRAWER M√ìVIL ======= -->
  <aside class="drawer" id="drawer" aria-hidden="true" inert>
    <div class="drawer__panel" role="dialog" aria-label="Men√∫ m√≥vil" aria-modal="true">
      <button class="drawer__close" id="btnCloseDrawer" aria-label="Cerrar men√∫">
        <span></span><span></span>
      </button>

      <nav class="drawer__menu">
        <a class="drawer__link" href="{% url 'webmaga:index' %}">Inicio</a>
        <a class="drawer__link" href="{% url 'webmaga:mapa-completo' %}">Mapa</a>

        <div class="ddm">
          <button class="ddm__btn" aria-expanded="false">
            Proyectos Activos <span class="car"></span>
          </button>
          <div class="ddm__panel">
            <a href="{% url 'webmaga:proyectos' %}" class="ddm__item">Ver Todos</a>
            <a href="{% url 'webmaga:proyectos' %}#capacitaciones" class="ddm__item">Capacitaciones</a>
            <a href="{% url 'webmaga:proyectos' %}#entregas" class="ddm__item">Entregas</a>
            <a href="{% url 'webmaga:proyectos' %}#proyectos-ayuda" class="ddm__item">Proyectos de Ayuda</a>
          </div>
        </div>

        <!-- Gestiones M√≥vil (Solo para Admin) -->
        {% if es_admin %}
        <div class="ddm">
          <button class="ddm__btn" aria-expanded="false">
            Gestiones <span class="car"></span>
          </button>
          <div class="ddm__panel">
            <a href="#" onclick="handleGestionesAction('createEventView'); return false;" class="ddm__item">Agregar Evento</a>
            <a href="#" onclick="handleGestionesAction('manageEventView'); return false;" class="ddm__item">Editar Evento</a>
            <a href="{% url 'webmaga:gestionusuarios' %}" class="ddm__item">Gesti√≥n Usuarios</a>
            <a href="{% url 'webmaga:reportes-index' %}" class="ddm__item">Crear Reporte</a>
          </div>
        </div>
        {% endif %}

        <div class="ddm">
          <button class="ddm__btn" aria-expanded="false">
            Comunidades <span class="car"></span>
          </button>
          <div class="ddm__panel">
            <div class="ddm__search">
              <button type="button" class="ddm__search-btn" id="search-comunidades-mobile-btn" aria-label="Buscar comunidades" title="Buscar comunidades">
                <svg class="icon icon--white" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="8"></circle>
                  <path d="m21 21-4.35-4.35"></path>
                </svg>
              </button>
              <input type="search" placeholder="Buscar comunidades‚Ä¶" aria-label="Buscar comunidades" id="search-comunidades-mobile">
            </div>
            <a href="{% url 'webmaga:comunidades' %}" class="ddm__item">Ver Comunidades</a>
            <a href="{% url 'webmaga:regiones' %}" class="ddm__item">Ver Regiones</a>
          </div>
        </div>

        <!-- Usuario en m√≥vil -->
        <div class="ddm" id="mobileUserMenu">
          <!-- Contenido cuando hay sesi√≥n activa -->
          <div id="mobileUserLoggedIn" style="display: {% if user.is_authenticated %}block{% else %}none{% endif %};">
            <button class="ddm__btn" aria-expanded="false">
            <div class="mobile-user-info">
              <div class="mobile-user-avatar" id="mobileUserAvatar">
                <span class="avatar-initial-text" id="mobileUserAvatarInitial">{% if usuario_maga %}{{ usuario_maga.username|first|upper }}{% else %}U{% endif %}</span>
                <img id="mobileUserAvatarImage" src="" alt="Foto de perfil" style="display: none;">
              </div>
              <span id="mobileUserName">
                {% if usuario_maga %}{{ usuario_maga.username }}{% else %}Usuario{% endif %}
              </span>
            </div>
            <span class="car"></span>
          </button>
          <div class="ddm__panel">
            <div class="mobile-user-details">
              <div class="mobile-user-email" id="mobileUserEmail">
                {% if usuario_maga %}{{ usuario_maga.email }}{% else %}usuario@maga.gt{% endif %}
              </div>
            </div>
            <a href="{% url 'webmaga:perfilusuario' %}" class="ddm__item mobile-user-action" id="mobileProfileBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Mi Perfil
            </a>
            <a href="{% url 'webmaga:configgeneral' %}" class="ddm__item mobile-user-action" id="mobileSettingsBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
              Configuraci√≥n
            </a>
            <button class="ddm__item mobile-user-action mobile-logout" id="mobileLogoutBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Cerrar Sesi√≥n
            </button>
          </div>
          </div>

          <!-- Contenido cuando NO hay sesi√≥n activa -->
          <div id="mobileUserLoggedOut" style="display: {% if user.is_authenticated %}none{% else %}block{% endif %};">
            <button class="ddm__btn" aria-expanded="false">
              <div class="mobile-user-info">
                <div class="mobile-user-avatar">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                </div>
                <span>Iniciar Sesi√≥n</span>
              </div>
              <span class="car"></span>
            </button>
            <div class="ddm__panel">
              <div class="mobile-user-details">
                <div class="mobile-user-email">Accede al sistema</div>
              </div>
              <a href="{% url 'webmaga:configgeneral' %}" class="ddm__item mobile-user-action" id="mobileConfigBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"></circle>
                  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                Configuraci√≥n
              </a>
              <button class="ddm__item mobile-user-action mobile-login" id="mobileLoginBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                  <polyline points="10 17 15 12 10 7"></polyline>
                  <line x1="15" y1="12" x2="3" y2="12"></line>
                </svg>
                Acceder al Sistema
              </button>
            </div>
          </div>
        </div>
      </nav>
    </div>
  </aside>

  
  <!-- ======= CONTENIDO PRINCIPAL ======= -->
  {% block content %}
  {% endblock %}

  <!-- ======= SECCI√ìN DE CONTACTO / FOOTER ======= -->
  <footer class="contact-section">
    <div class="contact-container">
      <!-- Columna izquierda - Informaci√≥n de contacto -->
      <div class="contact-info">
        <div class="contact-item">
          <svg class="contact-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          <div class="contact-text">
            <p><strong>Oficina Regional</strong></p>
            <p>Kil√≥metro 164.5 CA-14</p>
            <p>Purulh√°, B.V.</p>
          </div>
        </div>
        
        <div class="contact-item">
          <svg class="contact-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
          </svg>
          <div class="contact-text">
            <p>(502) 3015-6925</p>
          </div>
        </div>
        
        <div class="contact-item">
          <svg class="contact-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
          </svg>
          <div class="contact-text">
            <p>magabvpurulha@gmail.com</p>
          </div>
        </div>
      </div>

      <!-- Columna central - Logo -->
      <div class="contact-logo">
        <img src="{% static 'img/logos/logo_maga.png' %}" alt="Logo MAGA" class="maga-logo">
      </div>

      <!-- Columna derecha - Redes sociales y enlaces -->
      <div class="contact-links">
        <h4>√önete a nuestra comunidad</h4>
        <div class="social-links">
          <a href="https://www.facebook.com/maga.gt" target="_blank" rel="noopener noreferrer" class="social-link facebook" aria-label="Facebook">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
            </svg>
          </a>
          <a href="https://www.instagram.com/magaguatemala/" target="_blank" rel="noopener noreferrer" class="social-link instagram" aria-label="Instagram">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
              <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
              <line x1="17.5" y1="6.5" x2="17.5" y2="6.5" stroke-linecap="round"></line>
            </svg>
          </a>
        </div>
        <div class="footer-links">
          <a href="{% url 'webmaga:preguntas-frecuentes' %}" class="footer-link">Preguntas Frecuentes</a>
        </div>
      </div>
    </div>
    <!-- Copyright -->
    <div class="footer-copyright">
      <p>&copy; 2025 Todos los Derechos Reservados | Oficina Regional MAGA Purulh√° km 164,5 CA-14</p>
    </div>
  </footer>

  <!-- ======= SCRIPTS BASE ======= -->
  <div id="djangoContextData"
       data-url-mapa-completo="{% url 'webmaga:mapa-completo' %}"
       data-url-login="{% url 'webmaga:login' %}"
       data-url-logout="{% url 'webmaga:logout' %}"
       data-url-gestiones="{% url 'webmaga:gestioneseventos' %}"
       data-url-proyectos="{% url 'webmaga:proyectos' %}"
       data-url-reportes="{% url 'webmaga:reportes-index' %}"
       data-url-perfil="{% url 'webmaga:perfilusuario' %}"
       data-url-config="{% url 'webmaga:configgeneral' %}"
       data-url-preguntas="{% url 'webmaga:preguntas-frecuentes' %}"
       data-url-usuario="{% url 'webmaga:api-usuario' %}"
       data-url-calendar="{% url 'webmaga:api-calendar-events' %}"
       data-url-events-list="{% url 'webmaga:api-events-list' %}"
       data-url-avances="{% url 'webmaga:api-avances' %}"
       data-url-reminders="{% url 'webmaga:api-reminders' %}"
       data-url-reminders-pending="{% url 'webmaga:api-reminders-pending' %}"
       data-url-marcar-notificacion="/api/reminders/"
       data-url-collaborators="{% url 'webmaga:api-collaborators' %}"
       data-user-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}"
       data-user-admin="{% if es_admin %}true{% else %}false{% endif %}"
       data-user-personal="{% if es_personal %}true{% else %}false{% endif %}"
       data-user-username="{{ usuario_maga.username|default:'' }}"
       data-user-email="{{ usuario_maga.email|default:'' }}"
       style="display:none;"></div>

  <script src="{% static 'js/context-loader.js' %}?v=2"></script>
  <script src="{% static 'js/offline-db.js' %}"></script>
  <script src="{% static 'js/offline-auth.js' %}"></script>
  <script src="{% static 'js/offline-sync.js' %}"></script>
  <script src="{% static 'js/offline-diagnostico.js' %}"></script>
  <script src="{% static 'js/navigation.js' %}?v=3"></script>
  <script src="{% static 'js/admin-gestiones.js' %}"></script>
  
  <!-- Registrar Service Worker para notificaciones en todas las p√°ginas -->
  <script>
    // Registrar Service Worker para notificaciones push (funciona en todas las p√°ginas)
    function registerServiceWorkerGlobal() {
      if (!('serviceWorker' in navigator)) {
        console.warn('[Notificaciones] Service Worker no soportado en este navegador');
        return;
      }
      
      // Verificar que estamos en HTTPS (requerido para Service Workers, excepto localhost)
      if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        console.warn('[Notificaciones] Service Worker requiere HTTPS (excepto localhost)');
        return;
      }
      
      console.log('[Notificaciones] Registrando Service Worker globalmente...');
      
      navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
        .then(registration => {
          console.log('[Notificaciones] ‚úÖ Service Worker registrado exitosamente');
          
          // Escuchar actualizaciones
          registration.addEventListener('updatefound', () => {
            console.log('[Notificaciones] Nueva versi√≥n del Service Worker encontrada');
            const newWorker = registration.installing;
            if (newWorker) {
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'activated') {
                  console.log('[Notificaciones] ‚úÖ Nuevo Service Worker ACTIVADO');
                }
              });
            }
          });
          
          // Verificar estado peri√≥dicamente
          setInterval(() => {
            registration.update().catch(err => {
              console.warn('[Notificaciones] Error al actualizar Service Worker:', err);
            });
          }, 60000); // Cada minuto
        })
        .catch(error => {
          console.error('[Notificaciones] ‚ùå Error al registrar Service Worker:', error);
        });
    }
    
    // Registrar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', registerServiceWorkerGlobal);
    } else {
      registerServiceWorkerGlobal();
    }
  </script>
  
  <!-- Sistema de notificaciones global para todas las p√°ginas (excepto index.html que tiene su propio sistema) -->
  <script>
    (function() {
      'use strict';
      
      // Solo ejecutar si NO estamos en index.html (para no interferir con el calendario)
      const isIndexPage = window.location.pathname === '/' || window.location.pathname === '/index/' || window.location.pathname.includes('index');
      if (isIndexPage) {
        console.log('[Notificaciones Globales] P√°gina index.html detectada, usando sistema de notificaciones del calendario');
        return; // No ejecutar el sistema global en index.html
      }
      
      // Funci√≥n para verificar si el usuario est√° autenticado (m√∫ltiples m√©todos)
      async function checkUserAuthenticated() {
        // M√©todo 0: Verificar si hay sesi√≥n offline activa (prioridad cuando est√° offline)
        const hasOfflineSession = window.OfflineAuth && window.OfflineAuth.getActiveSession && window.OfflineAuth.getActiveSession();
        if (hasOfflineSession && hasOfflineSession.userInfo) {
          console.log('[Notificaciones Globales] Usuario autenticado (sesi√≥n offline activa)');
          return true;
        }
        
        // M√©todo 1: Verificar elemento djangoContextData
        const djangoContext = document.getElementById('djangoContextData');
        if (djangoContext) {
          const authAttr = djangoContext.getAttribute('data-user-authenticated');
          if (authAttr === 'true') {
            console.log('[Notificaciones Globales] Usuario autenticado (m√©todo 1: djangoContextData)');
            return true;
          }
        }
        
        // M√©todo 2: Verificar haciendo una petici√≥n a la API de notificaciones
        // Si la API responde con session_active: true, el usuario est√° autenticado
        // Solo si hay conexi√≥n, si est√° offline no intentar
        if (navigator.onLine) {
          try {
            const testUrl = '/api/reminders/notifications/';
            const testRes = await fetch(testUrl, {
              method: 'GET',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
              },
              credentials: 'same-origin',
              cache: 'no-store'
            });
            
            if (testRes.ok) {
              // Verificar Content-Type antes de parsear
              const contentType = testRes.headers.get('content-type');
              if (contentType && contentType.includes('application/json')) {
                const testData = await testRes.json();
                if (testData.session_active === true) {
                  console.log('[Notificaciones Globales] Usuario autenticado (m√©todo 2: API)');
                  return true;
                }
              }
            }
          } catch (error) {
            // Si est√° offline, no mostrar error
            if (navigator.onLine && !(error.name === 'TypeError' && error.message.includes('Failed to fetch'))) {
              console.warn('[Notificaciones Globales] Error al verificar autenticaci√≥n v√≠a API:', error);
            }
          }
        }
        
        // Si est√° offline y hay sesi√≥n offline, considerar autenticado
        if (!navigator.onLine && hasOfflineSession) {
          console.log('[Notificaciones Globales] Usuario autenticado (offline con sesi√≥n)');
          return true;
        }
        
        console.log('[Notificaciones Globales] Usuario NO autenticado');
        return false;
      }
      
      // Variables globales
      let notificationPermission = 'default';
      let reminderCheckInterval = null;
      const sentNotifications = new Set(); // Para evitar duplicados
      const scheduledNotifications = new Map(); // Para programar notificaciones futuras
      
      // Obtener CSRF token
      function getCSRFToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'csrftoken') {
            return decodeURIComponent(value);
          }
        }
        return '';
      }
      const CSRF_TOKEN = getCSRFToken();
      
      // Solicitar permiso de notificaciones
      async function requestNotificationPermission() {
        if (!('Notification' in window)) {
          console.warn('[Notificaciones Globales] Notificaciones no soportadas en este navegador');
          return false;
        }
        
        if (Notification.permission === 'granted') {
          notificationPermission = 'granted';
          return true;
        }
        
        if (Notification.permission === 'denied') {
          notificationPermission = 'denied';
          console.warn('[Notificaciones Globales] Permiso de notificaciones denegado');
          return false;
        }
        
        // Solicitar permiso
        try {
          const permission = await Notification.requestPermission();
          notificationPermission = permission;
          return permission === 'granted';
        } catch (error) {
          console.error('[Notificaciones Globales] Error al solicitar permiso:', error);
          return false;
        }
      }
      
      // Mostrar notificaci√≥n
      async function showGlobalNotification(reminder, isReenviar = false) {
        const title = isReenviar ? 'üîî Recordatorio (Recordar)' : 'üîî Recordatorio';
        
        // Construir el cuerpo de la notificaci√≥n
        let bodyParts = [];
        if (reminder.descripcion) {
          bodyParts.push(reminder.descripcion);
        }
        const evento = reminder.evento_nombre || reminder.titulo || 'Sin evento';
        bodyParts.push(`üìÖ Evento: ${evento}`);
        if (reminder.fecha && reminder.hora) {
          bodyParts.push(`üïê ${reminder.fecha} a las ${reminder.hora}`);
        }
        if (reminder.owners_text) {
          bodyParts.push(`üë• Personal: ${reminder.owners_text}`);
        }
        const body = bodyParts.join('\n') || 'Tienes un recordatorio';
        const tag = `reminder-${reminder.id}${isReenviar ? '-reenviar' : ''}`;
        
        // Detectar si es Android
        const isAndroid = /Android/i.test(navigator.userAgent);
        
        // Usar Service Worker si est√° disponible
        if ('serviceWorker' in navigator) {
          try {
            const registration = await navigator.serviceWorker.ready;
            if (registration.active) {
              await registration.showNotification(title, {
                body: body,
                icon: '/static/img/logos/logo_maga.png',
                badge: '/static/img/logos/logo_maga.png',
                tag: tag,
                requireInteraction: false,
                silent: false,
                vibrate: isAndroid ? [200, 100, 200] : undefined,
                data: {
                  reminderId: reminder.id,
                  isReenviar: isReenviar
                },
                timestamp: Date.now()
              });
              
              console.log('[Notificaciones Globales] ‚úÖ Notificaci√≥n mostrada desde Service Worker');
              
              // Marcar como enviado si no es reenv√≠o
              if (!isReenviar && !reminder.enviado) {
                marcarNotificacionComoEnviada(reminder.id);
              }
              
              return;
            }
          } catch (error) {
            console.error('[Notificaciones Globales] Error con Service Worker:', error);
          }
        }
        
        // Fallback: usar new Notification()
        if ('Notification' in window && Notification.permission === 'granted') {
          try {
            const notification = new Notification(title, {
              body: body,
              icon: '/static/img/logos/logo_maga.png',
              badge: '/static/img/logos/logo_maga.png',
              tag: tag
            });
            
            notification.onshow = () => {
              console.log('[Notificaciones Globales] ‚úÖ Notificaci√≥n mostrada (fallback)');
              if (!isReenviar && !reminder.enviado) {
                marcarNotificacionComoEnviada(reminder.id);
              }
            };
            
            notification.onclick = () => {
              window.focus();
              notification.close();
            };
          } catch (error) {
            console.error('[Notificaciones Globales] Error al crear notificaci√≥n:', error);
          }
        }
      }
      
      // Marcar notificaci√≥n como enviada
      async function marcarNotificacionComoEnviada(reminderId) {
        try {
          const url = `/api/reminders/${reminderId}/marcar-enviado/`;
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': CSRF_TOKEN || ''
            },
            credentials: 'same-origin'
          });
          
          if (res.ok) {
            console.log('[Notificaciones Globales] ‚úÖ Notificaci√≥n marcada como enviada:', reminderId);
          }
        } catch (error) {
          console.error('[Notificaciones Globales] Error al marcar como enviada:', error);
        }
      }
      
      // Verificar recordatorios pendientes
      async function checkGlobalReminders() {
        // Si est√° offline, no intentar verificar recordatorios
        if (!navigator.onLine) {
          return;
        }
        
        try {
          console.log('[Notificaciones Globales] Verificando recordatorios...');
          const url = '/api/reminders/notifications/';
          const res = await fetch(url, {
            method: 'GET',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'application/json',
              'Cache-Control': 'no-cache'
            },
            credentials: 'same-origin',
            cache: 'no-store'
          });
          
          if (!res.ok) {
            // Solo mostrar error si no es un error offline esperado (503 cuando est√° offline)
            if (res.status === 503 && !navigator.onLine) {
              // Error offline esperado, ignorar silenciosamente
              return;
            }
            
            // Solo mostrar warning si no es un error de red (offline)
            if (res.status !== 0) {
              console.warn('[Notificaciones Globales] Error en respuesta:', res.status, res.statusText);
            }
            
            if (res.status === 401 || res.status === 403) {
              console.log('[Notificaciones Globales] Usuario no autenticado, deteniendo verificaci√≥n');
              if (reminderCheckInterval) {
                clearInterval(reminderCheckInterval);
                reminderCheckInterval = null;
              }
            }
            return;
          }
          
          const data = await res.json();
          console.log('[Notificaciones Globales] Datos recibidos:', { 
            session_active: data.session_active, 
            reminders_count: (data.reminders || []).length 
          });
          
          if (!data.session_active) {
            console.log('[Notificaciones Globales] Sesi√≥n no activa');
            return;
          }
          
          const reminders = data.reminders || [];
          if (reminders.length === 0) {
            console.log('[Notificaciones Globales] No hay recordatorios pendientes');
            return;
          }
          
          console.log(`[Notificaciones Globales] Procesando ${reminders.length} recordatorio(s)`);
          const ahora = Date.now();
          
          reminders.forEach(reminder => {
            const reminderId = reminder.id;
            const tiempoRestante = reminder.tiempo_restante_segundos || 0;
            const recordar = reminder.recordar || false;
            const yaEnviado = reminder.enviado || false;
            
            // Clave √∫nica para evitar duplicados
            const notificationKey = `${reminderId}-${yaEnviado ? 'reenviar' : 'principal'}`;
            
            // Si ya fue enviado recientemente, saltar
            if (sentNotifications.has(notificationKey)) {
              return;
            }
            
            console.log('[Notificaciones Globales] Procesando recordatorio:', {
              reminderId,
              tiempoRestante,
              recordar,
              yaEnviado,
              notificationKey
            });
            
            // Si el recordatorio ya pas√≥ (dentro de los 15 minutos)
            if (tiempoRestante <= 0 && tiempoRestante >= -900) {
              console.log('[Notificaciones Globales] Recordatorio ya pas√≥, verificando si mostrar notificaci√≥n');
              // Si ya fue enviado y NO tiene "recordar", saltar
              if (yaEnviado && !recordar) {
                console.log('[Notificaciones Globales] Recordatorio ya enviado y sin "recordar", saltando');
                return;
              }
              
              // Si ya fue enviado y tiene "recordar", mostrar como reenv√≠o
              const isReenviar = yaEnviado && recordar;
              
              console.log('[Notificaciones Globales] Mostrando notificaci√≥n inmediatamente:', { reminderId, isReenviar });
              // Mostrar notificaci√≥n inmediatamente
              showGlobalNotification(reminder, isReenviar);
              
              // Marcar como enviado para evitar duplicados
              sentNotifications.add(notificationKey);
              setTimeout(() => {
                sentNotifications.delete(notificationKey);
              }, 5 * 60 * 1000); // 5 minutos
              
            } else if (tiempoRestante > 0) {
              console.log('[Notificaciones Globales] Recordatorio futuro, programando notificaci√≥n');
              // Recordatorio futuro: programar notificaci√≥n para cuando llegue la hora
              const dueAtTimestamp = reminder.due_at_timestamp || (ahora + tiempoRestante * 1000);
              const delay = dueAtTimestamp - ahora;
              
              // Programar notificaci√≥n para cuando llegue la hora (sin l√≠mite de tiempo)
              if (delay > 0) {
                // Cancelar notificaci√≥n programada anterior si existe
                const existing = scheduledNotifications.get(reminderId);
                if (existing && existing.timeoutId) {
                  clearTimeout(existing.timeoutId);
                }
                
                // Programar nueva notificaci√≥n
                const timeoutId = setTimeout(() => {
                  // Verificar que no haya pasado m√°s de 15 minutos desde la hora programada
                  const tiempoActual = Date.now();
                  const tiempoDesdeDueAt = Math.abs((dueAtTimestamp - tiempoActual) / 1000);
                  const LIMITE_SEGUNDOS = 15 * 60; // 15 minutos
                  
                  if (tiempoDesdeDueAt <= LIMITE_SEGUNDOS) {
                    if (!sentNotifications.has(`${reminderId}-principal`)) {
                      showGlobalNotification(reminder, false);
                      sentNotifications.add(`${reminderId}-principal`);
                      setTimeout(() => {
                        sentNotifications.delete(`${reminderId}-principal`);
                      }, 5 * 60 * 1000);
                    }
                  }
                  scheduledNotifications.delete(reminderId);
                }, delay);
                
                scheduledNotifications.set(reminderId, {
                  timeoutId: timeoutId,
                  reminder: reminder
                });
                
                console.log('[Notificaciones Globales] Notificaci√≥n programada:', {
                  reminderId,
                  delaySegundos: Math.round(delay / 1000),
                  tiempoRestanteSegundos: tiempoRestante
                });
              }
            }
          });
        } catch (error) {
          // Solo mostrar error si no es un error de red esperado (offline)
          if (error.name !== 'TypeError' || !error.message.includes('Failed to fetch')) {
            console.error('[Notificaciones Globales] Error al verificar recordatorios:', error);
          }
          // Si es un error de red (offline), ignorar silenciosamente
        }
      }
      
      // Inicializar sistema de notificaciones globales
      async function initGlobalNotificationSystem() {
        console.log('[Notificaciones Globales] Inicializando sistema...');
        console.log('[Notificaciones Globales] URL actual:', window.location.pathname);
        
        // Verificar autenticaci√≥n antes de continuar
        // PERO: No cancelar si estamos en una p√°gina p√∫blica como proyectos, comunidades, regiones, index
        const publicPages = ['/proyectos/', '/comunidades/', '/regiones/', '/', '/index/'];
        const isPublicPage = publicPages.some(page => window.location.pathname === page || window.location.pathname.startsWith(page));
        
        const isUserAuthenticated = await checkUserAuthenticated();
        if (!isUserAuthenticated && !isPublicPage) {
          console.log('[Notificaciones Globales] Usuario no autenticado, cancelando inicializaci√≥n');
          return;
        }
        
        // Si es una p√°gina p√∫blica, continuar sin verificar autenticaci√≥n
        if (isPublicPage) {
          console.log('[Notificaciones Globales] P√°gina p√∫blica detectada, continuando sin verificar autenticaci√≥n');
        }
        
        console.log('[Notificaciones Globales] Usuario autenticado, continuando...');
        
        // Solicitar permisos
        const hasPermission = await requestNotificationPermission();
        console.log('[Notificaciones Globales] Permiso de notificaciones:', Notification.permission);
        if (!hasPermission) {
          console.warn('[Notificaciones Globales] Permiso de notificaciones no concedido');
          // Continuar de todas formas para verificar recordatorios (el Service Worker puede mostrar notificaciones)
        }
        
        // Verificar recordatorios inmediatamente
        console.log('[Notificaciones Globales] Verificando recordatorios iniciales...');
        await checkGlobalReminders();
        
        // Verificar cada 30 segundos
        reminderCheckInterval = setInterval(() => {
          console.log('[Notificaciones Globales] Verificaci√≥n peri√≥dica...');
          checkGlobalReminders();
        }, 30000);
        
        // Verificar cuando la p√°gina se vuelve visible
        document.addEventListener('visibilitychange', () => {
          console.log('[Notificaciones Globales] Cambio de visibilidad:', document.visibilityState);
          if (document.visibilityState === 'visible') {
            checkGlobalReminders();
          }
        });
        
        // Verificar cuando la ventana se enfoca
        window.addEventListener('focus', () => {
          console.log('[Notificaciones Globales] Ventana enfocada');
          checkGlobalReminders();
        });
        
        console.log('[Notificaciones Globales] Sistema inicializado correctamente');
      }
      
      // Inicializar cuando el DOM est√© listo (con m√°s tiempo para asegurar que todo est√© cargado)
      function startNotificationSystem() {
        // Esperar un poco m√°s para asegurar que el DOM est√© completamente cargado
        setTimeout(async () => {
          await initGlobalNotificationSystem();
        }, 1500);
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', startNotificationSystem);
      } else {
        startNotificationSystem();
      }
    })();
  </script>
  
  {% block extra_js %}{% endblock %}
</body>
</html>

